---
- name: Configure port-channels
  hosts: nexus
  connection: network_cli
  gather_facts: no

  tasks:
  - name: Enable lacp on lab-sw03
    when: inventory_hostname == 'lab-sw03'
    cisco.nxos.nxos_feature:
      feature: lacp
      state: enabled
    
  - name: Enable lacp on lab-sw04
    when: inventory_hostname == 'lab-sw04'
    cisco.nxos.nxos_feature:
      feature: lacp
      state: enabled

  - name: Configure port-channel 11 as trunk port on lab-sw03
    when: inventory_hostname == 'lab-sw03'
    cisco.nxos.nxos_l2_interfaces:
      config:
          - name: port-channel11
            mode: trunk
            trunk:
              allowed_vlans: 10,20
      state: merged
  
  - name: Configure port-channel 12 as trunk port on lab-sw04
    when: inventory_hostname == 'lab-sw04'
    cisco.nxos.nxos_l2_interfaces:
      config:
          - name: port-channel12
            mode: trunk
            trunk:
              allowed_vlans: 10,20
      state: merged

  - name: Configure port-channels & assigning interfaces on lab-sw03
    when: inventory_hostname == 'lab-sw03'
    cisco.nxos.nxos_lag_interfaces:
      config:
        - name: port-channel11
          members:
              - member: Ethernet1/1
                mode: active
                force: true
              - member: Ethernet1/2
                mode: active
                force: true
      state: merged

  - name: Configure port-channels & assigning interfaces on lab-sw04
    when: inventory_hostname == 'lab-sw04'
    cisco.nxos.nxos_lag_interfaces:
      config:
        - name: port-channel12
          members:
              - member: Ethernet1/1
                mode: active
                force: true
              - member: Ethernet1/2
                mode: active
                force: true
      state: merged

  - name: Assigning interfaces to port-channels on lab-sw01
    when: inventory_hostname == 'lab-sw01'
    cisco.nxos.nxos_lag_interfaces:
      config:
        - name: port-channel11
          members:
            - member: Ethernet1/2
              mode: active
              force: true

        - name: port-channel12
          members:
            - member: Ethernet1/3
              mode: active
              force: true
      state: merged

  - name: Assigning interfaces to port-channels on lab-sw02
    when: inventory_hostname == 'lab-sw02'
    cisco.nxos.nxos_lag_interfaces:
      config:
        - name: port-channel11
          members:
            - member: Ethernet1/2
              mode: active
              force: true

        - name: port-channel12
          members:
            - member: Ethernet1/3
              mode: active
              force: true
      state: merged

  - name: Configure port-channels on lab-sw01
    when: inventory_hostname == 'lab-sw01'
    cisco.nxos.nxos_vpc_interface:
      portchannel: 11
      vpc: 11
      state: present

  - name: Configure port-channels on lab-sw01
    when: inventory_hostname == 'lab-sw01'      
    cisco.nxos.nxos_vpc_interface:
      portchannel: 12
      vpc: 12
      state: present

  - name: Configure port-channels on lab-sw02
    when: inventory_hostname == 'lab-sw02'
    cisco.nxos.nxos_vpc_interface:
      portchannel: 11
      vpc: 11
      state: present  

  - name: Configure port-channels on lab-sw02
    when: inventory_hostname == 'lab-sw02'      
    cisco.nxos.nxos_vpc_interface:
      portchannel: 12
      vpc: 12
      state: present

  - name: Configure port-channel 11 & 12 as trunk port on lab-sw01
    when: inventory_hostname == 'lab-sw01'
    cisco.nxos.nxos_l2_interfaces:
      config:
          - name: port-channel11
            mode: trunk
            trunk:
              allowed_vlans: 10,20
          - name: port-channel12
            mode: trunk
            trunk:
              allowed_vlans: 10,20
      state: merged

  - name: Configure port-channel 11 & 12 as trunk port on lab-sw02
    when: inventory_hostname == 'lab-sw02'
    cisco.nxos.nxos_l2_interfaces:
      config:
          - name: port-channel11
            mode: trunk
            trunk:
              allowed_vlans: 10,20
          - name: port-channel12
            mode: trunk
            trunk:
              allowed_vlans: 10,20
      state: merged