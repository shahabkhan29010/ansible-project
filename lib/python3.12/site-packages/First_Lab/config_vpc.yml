---
- name: Configuring VPC
  hosts: spine
  connection: network_cli
  gather_facts: no

  tasks:
    - name: Enable feature vpc
      cisco.nxos.nxos_feature:
        feature: vpc
        state: enabled

    - name: Enable feature vpc
      cisco.nxos.nxos_feature:
        feature: lacp
        state: enabled

    - name: Configure keepalive pkl_vrf
      cisco.nxos.nxos_vrf:
        name: keepalive
        admin_state: up
        state: present
  
    - name: Configure L3 interface eth 1/1 for keepalive on lab-sw01
      when: inventory_hostname == 'lab-sw01'
      cisco.nxos.nxos_interfaces:
        config:
          - name: Ethernet1/1
            description: 'vpc keepalive'
            enabled: true
            mode: layer3
        state: merged

    - name: Configure L3 interface eth 1/1 for keepalive on lab-sw02
      when: inventory_hostname == 'lab-sw02'
      cisco.nxos.nxos_interfaces:
        config:
          - name: Ethernet1/1
            description: 'vpc keepalive'
            enabled: true
            mode: layer3
        state: merged

    - name: Assign interface to keepalive vrf
      cisco.nxos.nxos_vrf_interface:
        vrf: keepalive
        interface: Ethernet1/1
        state: present

    - name: Assigning IP address to eth 1/1 on lab-sw01
      when: inventory_hostname == 'lab-sw01'
      cisco.nxos.nxos_l3_interfaces:
        config:
          - name: Ethernet1/1
            ipv4:
              - address: 1.1.1.1/30
        state: merged

    - name: Assigning IP address to eth 1/1 on lab-sw02
      when: inventory_hostname == 'lab-sw02'
      cisco.nxos.nxos_l3_interfaces:
        config:
          - name: Ethernet1/1
            ipv4:
              - address: 1.1.1.2/30
        state: merged

    - name: Configuring port-channel for VPC peer-link
      cisco.nxos.nxos_lag_interfaces:
        config:
          - name: port-channel101
            members:
              - member: Ethernet1/4
                member: Ethernet1/5
                mode: active
                force: true
        state: merged

    - name: Configure VPC
      when: inventory_hostname == 'lab-sw01'
      cisco.nxos.nxos_vpc:
        domain: 101
        role_priority: 1
        system_priority: 2000
        peer_gw: true
        peer_sw: true
        auto_recovery: true
        pkl_src: 1.1.1.1
        pkl_dest: 1.1.1.2
        pkl_vrf: keepalive

    - name: Configure VPC
      when: inventory_hostname == 'lab-sw02'
      cisco.nxos.nxos_vpc:
        domain: 101
        system_priority: 2000
        peer_gw: true
        peer_sw: true
        auto_recovery: true
        pkl_src: 1.1.1.2
        pkl_dest: 1.1.1.1
        pkl_vrf: keepalive

    - name: Configure vpc peer-link
      cisco.nxos.nxos_vpc_interface:
        peer_link: true
        portchannel: 101
        state: present
    
    - name: Configure portchannel 101 as trunk
      cisco.nxos.nxos_l2_interfaces:
        config:
          - name: PortChannel101
            mode: trunk
            trunk:
              allowed_vlans: 10,20
        state: merged

              