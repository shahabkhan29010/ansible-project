---
- name: Configure BGP on dc01 leaf01 switch
  when: inventory_hostname == 'leaf01'
  cisco.nxos.nxos_bgp_global:
    config:
      as_number: "{{ leaf01_asn }}"
      neighbors:
        - neighbor_address: "{{ item.ip_address }}"
          remote_as: "{{ item.remote_asn }}"
          shutdown: false
    state: merged
  loop: "{{ leaf01_neighbors }}"

- name: Configure BGP on dc01 leaf02 switch
  when: inventory_hostname == 'leaf02'
  cisco.nxos.nxos_bgp_global:
    config:
      as_number: "{{ leaf02_asn }}"
      neighbors:
        - neighbor_address: "{{ item.ip_address }}"
          remote_as: "{{ item.remote_asn }}"
          shutdown: false
    state: merged
  loop: "{{ leaf02_neighbors }}"

- name: Configure BGP on dc02 leaf03 switch
  when: inventory_hostname == 'leaf03'
  cisco.nxos.nxos_bgp_global:
    config:
      as_number: "{{ leaf03_asn }}"
      neighbors:
        - neighbor_address: "{{ item.ip_address }}"
          remote_as: "{{ item.remote_asn }}"
          shutdown: false
    state: merged
  loop: "{{ leaf03_neighbors }}"

- name: Configure BGP on dc02 leaf04 switch
  when: inventory_hostname == 'leaf04'
  cisco.nxos.nxos_bgp_global:
    config:
      as_number: "{{ leaf04_asn }}"
      neighbors:
        - neighbor_address: "{{ item.ip_address }}"
          remote_as: "{{ item.remote_asn }}"
          shutdown: false
    state: merged
  loop: "{{ leaf04_neighbors }}"

- name: Configure address family for leaf01
  when: inventory_hostname == 'leaf01'
  cisco.nxos.nxos_bgp_neighbor_address_family:
    config:
        as_number: "{{ leaf01_asn }}"
        neighbors:
          - neighbor_address: "{{ item.ip_address }}"
            address_family:
              - afi: ipv4
                safi: unicast
                soft_reconfiguration_inbound:
                  always: true
    state: merged
  loop: "{{ leaf01_neighbors }}"

- name: Configure address family for leaf02
  when: inventory_hostname == 'leaf02'
  cisco.nxos.nxos_bgp_neighbor_address_family:
    config:
        as_number: "{{ leaf02_asn }}"
        neighbors:
          - neighbor_address: "{{ item.ip_address }}"
            address_family:
              - afi: ipv4
                safi: unicast
                soft_reconfiguration_inbound:
                  always: true
    state: merged
  loop: "{{ leaf02_neighbors }}"

- name: Configure address family for leaf03
  when: inventory_hostname == 'leaf03'
  cisco.nxos.nxos_bgp_neighbor_address_family:
    config:
        as_number: "{{ leaf03_asn }}"
        neighbors:
          - neighbor_address: "{{ item.ip_address }}"
            address_family:
              - afi: ipv4
                safi: unicast
                soft_reconfiguration_inbound:
                  always: true
    state: merged
  loop: "{{ leaf03_neighbors }}"

- name: Configure address family for leaf04
  when: inventory_hostname == 'leaf04'
  cisco.nxos.nxos_bgp_neighbor_address_family:
    config:
        as_number: "{{ leaf04_asn }}"
        neighbors:
          - neighbor_address: "{{ item.ip_address }}"
            address_family:
              - afi: ipv4
                safi: unicast
                soft_reconfiguration_inbound:
                  always: true
    state: merged
  loop: "{{ leaf04_neighbors }}"

- name: Advertise local network on leaf01
  when: inventory_hostname == 'leaf01'
  cisco.nxos.nxos_bgp_address_family:
    config:
      as_number: "{{ leaf01_asn }}"
      address_family:
        - afi: ipv4
          safi: unicast
          maximum_paths:
            parallel_paths: 2
          networks:
            - prefix: 192.168.10.0/24
            - prefix: 192.168.20.0/24
            - prefix: 192.168.30.0/24
            - prefix: 192.168.40.0/24
    state: merged
  loop: "{{ leaf01_neighbors }}"

- name: Advertise local network on leaf02
  when: inventory_hostname == 'leaf02'
  cisco.nxos.nxos_bgp_address_family:
    config:
      as_number: "{{ leaf02_asn }}"
      address_family:
        - afi: ipv4
          safi: unicast
          maximum_paths:
            parallel_paths: 2
          networks:
            - prefix: 192.168.10.0/24
            - prefix: 192.168.20.0/24
            - prefix: 192.168.30.0/24
            - prefix: 192.168.40.0/24
    state: merged
  loop: "{{ leaf02_neighbors }}"

- name: Advertise local network on leaf03
  when: inventory_hostname == 'leaf03'
  cisco.nxos.nxos_bgp_address_family:
    config:
      as_number: "{{ leaf03_asn }}"
      address_family:
        - afi: ipv4
          safi: unicast
          maximum_paths:
            parallel_paths: 2
          networks:
            - prefix: 172.16.10.0/24
            - prefix: 172.16.20.0/24
            - prefix: 172.16.30.0/24
            - prefix: 172.16.40.0/24
    state: merged
  loop: "{{ leaf03_neighbors }}"

- name: Advertise local network on leaf04
  when: inventory_hostname == 'leaf04'
  cisco.nxos.nxos_bgp_address_family:
    config:
      as_number: "{{ leaf04_asn }}"
      address_family:
        - afi: ipv4
          safi: unicast
          maximum_paths:
            parallel_paths: 2
          networks:
            - prefix: 172.16.10.0/24
            - prefix: 172.16.20.0/24
            - prefix: 172.16.30.0/24
            - prefix: 172.16.40.0/24
    state: merged
  loop: "{{ leaf04_neighbors }}"